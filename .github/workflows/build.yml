name: Build AutoHotkey Script (Robust Install + Timed Verify)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # الخطوة 1: الحصول على الكود
    - name: Checkout code
      uses: actions/checkout@v4

    # الخطوة 2: تثبيت AutoHotkey وكل المكونات دفعة واحدة
    - name: Install AutoHotkey and All Components
      shell: pwsh
      run: |
        $zipUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.19/AutoHotkey_2.0.19.zip"
        $zipFile = "AutoHotkey.zip"
        Invoke-WebRequest -Uri $zipUrl -OutFile $zipFile
        $extractPath = ".\ahk_install_source"
        Expand-Archive -Path $zipFile -DestinationPath $extractPath
        Set-Location $extractPath
        & .\install.cmd /S /IsMachineInstall

    # الخطوة 3: التحقق الدوري من التثبيت ثم تحويل السكربت
    - name: Verify Installation with Timeout and Compile
      shell: pwsh
      run: |
        $compilerFolder = "C:\Program Files\AutoHotkey\Compiler"
        $compilerExe = "$compilerFolder\Ahk2Exe.exe"
        $outputFile = "$($env:GITHUB_WORKSPACE)\Playback.exe"

        # === حلقة التحقق مع مؤقت التي طلبتها ===
        Write-Output "Verifying compiler installation by waiting for folder: '$compilerFolder'..."
        $timeoutSeconds = 60
        $intervalSeconds = 5
        $timer = [System.Diagnostics.Stopwatch]::StartNew()
        
        while (-not (Test-Path $compilerFolder)) {
            if ($timer.Elapsed.TotalSeconds -ge $timeoutSeconds) {
                # إذا انتهى الوقت، أفشل الـ workflow برسالة واضحة
                throw "Timeout! Compiler folder not found at '$compilerFolder' after $timeoutSeconds seconds."
            }
            Write-Output "Compiler folder not found. Waiting for $intervalSeconds seconds before checking again..."
            Start-Sleep -Seconds $intervalSeconds
        }
        $timer.Stop()
        Write-Output "Success! Compiler folder found in $($timer.Elapsed.TotalSeconds) seconds."
        # ==========================================

        # الآن بعد أن تأكدنا من وجود كل شيء، نقوم بالتحويل
        Write-Output "Proceeding with compilation..."

        if (-not (Test-Path "$($env:GITHUB_WORKSPACE)\Playback.ahk")) {
            throw "ERROR: Source AHK file not found at '$($env:GITHUB_WORKSPACE)\Playback.ahk'"
        }

        if (-not (Test-Path $compilerExe)) {
            throw "ERROR: Compiler executable not found at '$compilerExe'"
        }

        & $compilerExe /in "$($env:GITHUB_WORKSPACE)\Playback.ahk" /out $outputFile /icon "$($env:GITHUB_WORKSPACE)\play_pause_icon_137298.ico"

        Write-Output "Ahk2Exe.exe exited with code: $LASTEXITCODE"

        if ($LASTEXITCODE -ne 0) {
            throw "Ahk2Exe.exe failed with exit code $LASTEXITCODE. There was a compilation error."
        }

        if (-not (Test-Path $outputFile)) {
            throw "VERIFICATION FAILED! The output file was not found after compilation."
        }

        Write-Output "SUCCESS! Compiled file has been verified at '$outputFile'."

        
    # الخطوة 4: رفع الملف التنفيذي الناتج
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: Compiled-Program
        path: Playback.exe