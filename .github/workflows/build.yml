name: Build AutoHotkey Script (User's Final Method)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # الخطوة 1: الحصول على كود السكربت الخاص بك
    - name: Checkout code
      uses: actions/checkout@v4

    # الخطوة 2: تثبيت نواة AutoHotkey (حسب تعليماتك)
    - name: Install AutoHotkey Core
      shell: pwsh
      run: |
        Write-Output "Downloading the AutoHotkey setup executable..."
        $setupUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.19/AutoHotkey_2.0.19_setup.exe"
        $setupFile = "AutoHotkey_setup.exe"
        Invoke-WebRequest -Uri $setupUrl -OutFile $setupFile
        
        Write-Output "Running silent/elevated installation..."
        # نستخدم Start-Process مع -Wait لنضمن انتهاء التثبيت بالكامل قبل الانتقال للخطوة التالية
        Start-Process -FilePath $setupFile -ArgumentList "/silent /elevate" -Wait

    # الخطوة 3: تثبيت المحول Ahk2Exe (حسب تعليماتك)
    - name: Install Compiler (Ahk2Exe)
      shell: pwsh
      run: |
        Write-Output "Running the secondary installation script for the compiler..."
        # المسار المتوقع للمترجم بعد الخطوة السابقة
        $interpreterPath = "C:\Program Files\AutoHotkey\v2\AutoHotkey.exe"
        # المسار المتوقع لسكربت تثبيت المحول
        $installScriptPath = "C:\Program Files\AutoHotkey\UX\install-version.ahk"

        # نتأكد من وجود الملفات قبل تشغيلها
        if (-not (Test-Path $interpreterPath)) { throw "AutoHotkey.exe not found at $interpreterPath" }
        if (-not (Test-Path $installScriptPath)) { throw "install-version.ahk not found at $installScriptPath" }

        # نقوم بتشغيل السكربت وننتظر انتهاءه
        Start-Process -FilePath $interpreterPath -ArgumentList "/script `"$installScriptPath`"" -Wait

    # الخطوة 4: تحويل السكربت الخاص بك (الآن يجب أن يكون كل شيء جاهزاً)
    - name: Compile User Script
      shell: pwsh
      run: |
        Write-Output "Compiling the final script..."
        & "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe" /in "$($env:GITHUB_WORKSPACE)\Playback.ahk" /out "$($env:GITHUB_WORKSPACE)\Playback.exe" /icon "$($env:GITHUB_WORKSPACE)\play_pause_icon_137298.ico"
        
    # الخطوة 5: رفع الملف التنفيذي الناتج
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: Compiled-Program
        path: Playback.exe