name: Build AHK Script (Manual Install)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # الخطوة 1: الحصول على كود المستودع
    - name: Checkout code
      uses: actions/checkout@v4

    # الخطوة 2: تحميل، فك ضغط، وتثبيت AutoHotkey v2 بشكل صامت
    - name: Download, Extract, and Install AutoHotkey
      shell: pwsh
      run: |
        # === الرابط المباشر الجديد من GitHub ===
        $ahkUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.19/AutoHotkey_2.0.19.zip"
        $ahkZip = "autohotkey.zip"

        # تحميل الملف مباشرة (سيعمل الآن بدون مشاكل)
        Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkZip

        # فك الضغط في مجلد اسمه ahk
        Expand-Archive -Path $ahkZip -DestinationPath "ahk"

        # الدخول إلى المجلد
        Set-Location "ahk"
        
        # تشغيل التثبيت الصامت
        & .\install.cmd /S

    # === خطوة اختبار محسنة وسريعة ===
    # تبحث فقط في المجلدات المحتملة وتتوقف عند أول نتيجة
    - name: Find AutoHotkey Compiler (Optimized Search)
      shell: pwsh
      run: |
        # نحدد المجلدين الأكثر احتمالاً لوجود البرنامج فيهما
        $searchPaths = "C:\Program Files", "C:\Program Files (x86)"
        Write-Output "Searching for Ahk2Exe.exe in: $searchPaths"
        
        # الأمر التالي سيبحث في المسارات المحددة ويتوقف بمجرد العثور على أول ملف مطابق
        Get-ChildItem -Path $searchPaths -Recurse -Filter "Ahk2Exe.exe" -ErrorAction SilentlyContinue | Select-Object -First 1      

    # الخطوة 3: تحويل السكربت. الآن Ahk2Exe موجود ومتاح في النظام
    # لا حاجة لتغيير أي شيء هنا لأن المثبت يضيف المسار الصحيح تلقائياً
    - name: Compile AHK script
      run: |
        & "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe" /in "Playback.ahk" /out "Playback.exe" /icon "play_pause_icon_137298.ico"
        
    # الخطوة 4: رفع الملف الناتج
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: Compiled-Program
        path: Playback.exe